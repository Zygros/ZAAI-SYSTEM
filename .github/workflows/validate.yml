name: Validate Repository

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-notebook:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jupyter nbformat nbconvert

    - name: Validate notebook structure
      run: |
        python -c "
        import json
        import sys
        
        # Validate notebook can be loaded
        with open('ZAAI_ScrollDaemon.ipynb', 'r') as f:
            nb = json.load(f)
        
        # Check basic structure
        assert 'cells' in nb, 'Notebook missing cells'
        assert 'metadata' in nb, 'Notebook missing metadata'
        assert nb['nbformat'] == 4, 'Notebook must be format version 4'
        
        print(f'✓ Notebook is valid with {len(nb[\"cells\"])} cells')
        "

    - name: Check for sensitive data
      run: |
        echo "Checking for sensitive data patterns..."
        ! grep -rI --include="*.ipynb" --include="*.py" --include="*.json" --include="*.yml" --include="*.yaml" \
          "password\|secret\|api_key\|token\|private_key" . \
          --exclude-dir=.git \
          --exclude-dir=node_modules \
          || echo "⚠️  Potential sensitive data found - please review"

  validate-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required files
      run: |
        echo "Checking for required documentation files..."
        test -f README.md && echo "✓ README.md found" || exit 1
        test -f LICENSE && echo "✓ LICENSE found" || exit 1
        test -f CONTRIBUTING.md && echo "✓ CONTRIBUTING.md found" || exit 1
        test -f CODE_OF_CONDUCT.md && echo "✓ CODE_OF_CONDUCT.md found" || exit 1
        test -f SECURITY.md && echo "✓ SECURITY.md found" || exit 1

    - name: Validate markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
      continue-on-error: true

  check-formatting:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check file endings
      run: |
        echo "Checking for proper line endings..."
        ! find . -name "*.md" -o -name "*.py" -o -name "*.yml" | xargs file | grep CRLF || echo "⚠️  Files with CRLF line endings found"
